<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BirdText - Messages</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="stylesheet" href="/css/main.css">

  <!-- JsSIP for WebRTC calling (local copy) -->
  <script src="/libs/jssip.min.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar"></div>
          <div class="user-details">
            <div class="user-name" id="userName">Loading...</div>
            <div class="user-status">Online</div>
          </div>
          <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
        <div class="search-new-container">
          <input type="text" class="search-bar" placeholder="Search conversations..." id="searchBar">
          <div class="button-row">
            <button class="new-message-btn" id="contactsBtn">Contacts</button>
            <button class="new-message-btn" id="newMessageBtn">New</button>
          </div>
        </div>
      </div>

      <div class="conversations" id="conversationsList">
        <div class="loading">
          <div class="spinner"></div>
          Loading conversations...
        </div>
      </div>
    </div>

    <!-- Chat Area -->
    <div class="chat-area" id="chatArea">
      <div class="empty-state">
        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <div class="empty-state-text">Select a conversation</div>
        <div class="empty-state-subtext">Choose a contact to start messaging</div>
      </div>
    </div>
  </div>

  <!-- Contacts Modal -->
  <div class="modal-overlay" id="contactsModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">New Message</div>
        <div class="modal-subtitle">Select a contact to start messaging</div>
      </div>
      <input type="text" class="search-bar" placeholder="Search contacts..." id="contactSearch" style="margin-bottom: 16px;">
      <div class="contact-list" id="contactList"></div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeContactsModal()">Cancel</button>
        <button class="modal-btn modal-btn-primary" onclick="openCreateContactModal()">Create New Contact</button>
      </div>
    </div>
  </div>

  <!-- Create Contact Modal -->
  <div class="modal-overlay" id="createContactModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Create Contact</div>
        <div class="modal-subtitle">Add a new contact to your list</div>
      </div>
      <form id="createContactForm">
        <div style="margin-bottom: 16px;">
          <label style="display: block; color: white; font-weight: 600; margin-bottom: 8px; font-size: 14px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">Name</label>
          <input type="text" id="contactName" required
                 style="width: 100%; padding: 12px 16px; border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; font-size: 15px; color: white; background: rgba(255,255,255,0.15);"
                 placeholder="John Doe">
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: white; font-weight: 600; margin-bottom: 8px; font-size: 14px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">Phone Number</label>
          <input type="tel" id="contactPhone" required
                 style="width: 100%; padding: 12px 16px; border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; font-size: 15px; color: white; background: rgba(255,255,255,0.15);"
                 placeholder="+1 555 123 4567">
        </div>
        <div class="modal-buttons">
          <button type="button" class="modal-btn modal-btn-secondary" onclick="closeCreateContactModal()">Cancel</button>
          <button type="submit" class="modal-btn modal-btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Contact Modal -->
  <div class="modal-overlay" id="editContactModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Edit Contact</div>
        <div class="modal-subtitle">Update contact information</div>
      </div>
      <form id="editContactForm">
        <input type="hidden" id="editContactId">
        <div style="margin-bottom: 16px;">
          <label style="display: block; color: white; font-weight: 600; margin-bottom: 8px; font-size: 14px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">Name</label>
          <input type="text" id="editContactName" required
                 style="width: 100%; padding: 12px 16px; border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; font-size: 15px; color: white; background: rgba(255,255,255,0.15);"
                 placeholder="John Doe">
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: white; font-weight: 600; margin-bottom: 8px; font-size: 14px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">Phone Number</label>
          <input type="tel" id="editContactPhone" required
                 style="width: 100%; padding: 12px 16px; border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; font-size: 15px; color: white; background: rgba(255,255,255,0.15);"
                 placeholder="+1 555 123 4567">
        </div>
        <div class="modal-buttons">
          <button type="button" class="modal-btn modal-btn-secondary" onclick="closeEditContactModal()">Cancel</button>
          <button type="submit" class="modal-btn modal-btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Contact Confirmation Modal -->
  <div class="modal-overlay" id="deleteContactConfirmModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Delete Contact?</div>
        <div class="modal-subtitle" id="deleteContactConfirmText">This will permanently delete this contact. This action cannot be undone.</div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeDeleteContactModal()">Cancel</button>
        <button class="modal-btn modal-btn-primary" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);" onclick="confirmDeleteContact()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Contacts Management Modal -->
  <div class="modal-overlay" id="manageContactsModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Contacts</div>
        <div class="modal-subtitle">Manage your contacts</div>
      </div>
      <div class="modal-tabs">
        <button class="modal-tab active" id="contactsTab" onclick="switchContactsTab('contacts')">Contacts</button>
        <button class="modal-tab" id="spamTab" onclick="switchContactsTab('spam')">Spam</button>
      </div>
      <input type="text" class="search-bar" placeholder="Search contacts..." id="manageContactSearch" style="margin-bottom: 16px;">
      <div class="contact-list" id="manageContactList" style="max-height: 400px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeManageContactsModal()">Close</button>
        <button class="modal-btn modal-btn-primary" id="addContactBtn" onclick="openCreateContactFromManage()">Add Contact</button>
      </div>
    </div>
  </div>

  <!-- Send Confirmation Modal -->
  <div class="modal-overlay" id="sendConfirmModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Send Message?</div>
        <div class="modal-subtitle" id="sendConfirmText">Are you sure you want to send this message?</div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeSendModal()">Cancel</button>
        <button class="modal-btn modal-btn-primary" onclick="confirmSend()">Send</button>
      </div>
    </div>
  </div>

  <!-- Delete Conversation Confirmation Modal -->
  <div class="modal-overlay" id="deleteConfirmModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Delete Conversation?</div>
        <div class="modal-subtitle" id="deleteConfirmText">This will permanently delete all messages with this contact. This action cannot be undone.</div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeDeleteModal()">Cancel</button>
        <button class="modal-btn modal-btn-primary" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Voicemail Warning Modal -->
  <div class="modal-overlay" id="voicemailWarningModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">‚ö†Ô∏è Warning</div>
        <div class="modal-subtitle">Are you sure you want to expose your ears to this?</div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeVoicemailWarning()">Nevermind</button>
        <button class="modal-btn modal-btn-primary" onclick="confirmPlayVoicemail()">I'm Ready</button>
      </div>
    </div>
  </div>

  <!-- Call Confirmation Modal -->
  <div class="modal-overlay" id="callConfirmModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">üìû Call Confirmation</div>
        <div class="modal-subtitle" id="callConfirmText">Are you sure you actually want to talk to this person?</div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeCallConfirm()">Nevermind</button>
        <button class="modal-btn modal-btn-primary" onclick="confirmCall()">Yes, Call Them</button>
      </div>
    </div>
  </div>

  <!-- Mark as Spam Confirmation Modal -->
  <div class="modal-overlay" id="markSpamModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Mark as Spam?</div>
        <div class="modal-subtitle" id="markSpamText">You will never see their messages, calls, or voicemails again.</div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeMarkSpamModal()">Cancel</button>
        <button class="modal-btn modal-btn-primary" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);" onclick="confirmMarkSpam()">Mark as Spam</button>
      </div>
    </div>
  </div>

  <!-- Unmark Spam Confirmation Modal -->
  <div class="modal-overlay" id="unmarkSpamModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Unmark as Spam?</div>
        <div class="modal-subtitle" id="unmarkSpamText">This contact will be visible again and you'll receive their messages.</div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeUnmarkSpamModal()">Cancel</button>
        <button class="modal-btn modal-btn-primary" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);" onclick="confirmUnmarkSpam()">Unmark Spam</button>
      </div>
    </div>
  </div>

  <!-- Delete Note Confirmation Modal -->
  <div class="modal-overlay" id="deleteNoteModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Delete Note?</div>
        <div class="modal-subtitle">This will permanently delete this private note. This action cannot be undone.</div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeDeleteNoteModal()">Cancel</button>
        <button class="modal-btn modal-btn-primary" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);" onclick="confirmDeleteNote()">Delete Note</button>
      </div>
    </div>
  </div>

  <!-- AI Draft Reply Modal -->
  <div class="modal-overlay" id="aiDraftModal">
    <div class="modal ai-draft-modal">
      <div class="modal-header">
        <div class="modal-title">Draft Reply to <span id="aiDraftContactName"></span></div>
        <div class="modal-subtitle">AI will help you craft the perfect response</div>
      </div>

      <!-- Form Section -->
      <div id="aiDraftForm" class="ai-draft-form">
        <div class="form-group">
          <label>How do you know <span id="aiDraftContactName2"></span>?</label>
          <input type="text" id="aiRelationship" placeholder="e.g., close friend, work colleague, family member">
        </div>

        <div class="form-group">
          <label>What tone should I use?</label>
          <input type="text" id="aiTone" placeholder="e.g., warm and friendly, brief and professional, casual">
        </div>

        <div class="form-group">
          <label>Any additional context? (optional)</label>
          <textarea id="aiContext" rows="3" placeholder="e.g., They just got back from vacation, I owe them money, etc."></textarea>
        </div>

        <button class="modal-btn modal-btn-primary" id="aiGenerateBtn" onclick="generateAiReplies()">
          <span id="aiGenerateBtnText">Write Reply</span>
          <span id="aiGenerateSpinner" class="spinner" style="display: none;"></span>
        </button>
      </div>

      <!-- Loading State -->
      <div id="aiDraftLoading" class="ai-draft-loading" style="display: none;">
        <div class="spinner"></div>
        <div style="margin-top: 12px; font-size: 14px; opacity: 0.8;">Generating replies...</div>
      </div>

      <!-- Results Section -->
      <div id="aiDraftResults" class="ai-draft-results" style="display: none;">
        <div class="ai-draft-results-title">Choose a reply:</div>
        <div id="aiDraftCards" class="ai-draft-cards"></div>

        <!-- Refinement Section -->
        <div class="ai-draft-refinement">
          <div class="form-group" style="margin-bottom: 8px;">
            <input type="text" id="aiRefineContext" placeholder="Add more context and regenerate...">
          </div>
          <button class="modal-btn modal-btn-secondary" onclick="regenerateAiReplies()">Regenerate</button>
        </div>
      </div>

      <!-- Close Button -->
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeAiDraftModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Phone Dialer -->
  <button class="phone-toggle" id="phoneToggle" onclick="togglePhone()">
    <svg viewBox="0 0 24 24">
      <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 00-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"></path>
    </svg>
  </button>

  <div class="phone-sidebar" id="phoneSidebar">
    <!-- Contact selector -->
    <select class="phone-contact-selector" id="phoneContactSelector" onchange="selectContactForCall()">
      <option value="">Select a contact...</option>
    </select>

    <!-- Phone number display -->
    <input type="text" class="phone-display" id="phoneDisplay" readonly value="" placeholder="Enter number">

    <!-- Dialpad (3x4 grid) -->
    <div class="dialpad">
      <button class="dial-btn" onclick="dialDigit('1')">1</button>
      <button class="dial-btn" onclick="dialDigit('2')">2</button>
      <button class="dial-btn" onclick="dialDigit('3')">3</button>
      <button class="dial-btn" onclick="dialDigit('4')">4</button>
      <button class="dial-btn" onclick="dialDigit('5')">5</button>
      <button class="dial-btn" onclick="dialDigit('6')">6</button>
      <button class="dial-btn" onclick="dialDigit('7')">7</button>
      <button class="dial-btn" onclick="dialDigit('8')">8</button>
      <button class="dial-btn" onclick="dialDigit('9')">9</button>
      <button class="dial-btn" onclick="dialDigit('*')">*</button>
      <button class="dial-btn" onclick="dialDigit('0')">0</button>
      <button class="dial-btn" onclick="dialDigit('#')">#</button>
    </div>

    <!-- Call controls -->
    <div class="call-controls">
      <button class="call-btn" id="callBtn" onclick="showCallConfirm()">Call</button>
      <button class="hangup-btn" id="hangupBtn" onclick="hangupCall()" style="display:none">Hang Up</button>
      <button class="clear-btn" onclick="clearDisplay()">Clear</button>
    </div>

    <!-- Call status -->
    <div class="call-status" id="callStatus">Ready to call</div>
  </div>

  <!-- Hidden audio element for call audio -->
  <audio id="remoteAudio" autoplay></audio>

  <script defer src="/js/main.js"></script>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

</body>
</html>
