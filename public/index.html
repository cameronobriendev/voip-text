<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BirdText - Messages</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'SF UI Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      overflow: hidden;
    }

    .app-container {
      display: flex;
      height: 100vh;
      padding: 20px;
      gap: 20px;
    }

    /* Sidebar - Conversation List */
    .sidebar {
      width: 380px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex-shrink: 0;
    }

    .sidebar-header {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }

    .user-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .user-avatar {
      display: none;
    }

    .user-details {
      flex: 1;
      margin-left: 0;
    }

    .user-name {
      color: white;
      font-weight: 600;
      font-size: 16px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    .user-name:hover {
      transform: scale(1.02);
      text-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }

    .user-name:active {
      transform: scale(0.98);
    }

    .user-status {
      color: rgba(255, 255, 255, 0.9);
      font-size: 13px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
    }

    .toast {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      display: flex;
      align-items: flex-start;
      gap: 12px;
      min-width: 320px;
      max-width: 420px;
      pointer-events: auto;
      animation: toastSlideIn 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .toast.hiding {
      animation: toastSlideOut 0.3s ease forwards;
    }

    @keyframes toastSlideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes toastSlideOut {
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    .toast-icon {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      color: #1a202c;
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }

    .toast-message {
      color: #4a5568;
      font-size: 14px;
      line-height: 1.4;
    }

    .toast-close {
      background: none;
      border: none;
      color: #718096;
      font-size: 22px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
      flex-shrink: 0;
      line-height: 1;
    }

    .toast-close:hover {
      background: rgba(0,0,0,0.05);
      color: #1a202c;
    }

    .toast.success .toast-icon {
      color: #10b981;
    }

    .toast.success .toast-progress {
      background: linear-gradient(90deg, #10b981, #059669);
    }

    .toast.info .toast-icon {
      color: #3b82f6;
    }

    .toast.info .toast-progress {
      background: linear-gradient(90deg, #3b82f6, #2563eb);
    }

    .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      width: 100%;
      transform-origin: left;
      animation: toastProgress 4s linear forwards;
    }

    @keyframes toastProgress {
      to {
        transform: scaleX(0);
      }
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .search-new-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .search-bar {
      width: 100%;
      background: rgba(255, 255, 255, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.35);
      border-radius: 10px;
      padding: 11px 16px;
      color: white;
      font-size: 14px;
      transition: all 0.2s;
    }

    .button-row {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .search-bar::placeholder {
      color: rgba(255, 255, 255, 0.75);
    }

    .search-bar:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.35);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .new-message-btn {
      background: linear-gradient(135deg, #4A90E2 0%, #667eea 100%);
      border: none;
      border-radius: 10px;
      padding: 10px 18px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
      white-space: nowrap;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .new-message-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(74, 144, 226, 0.5);
    }

    .conversations {
      flex: 1;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }

    .conversation-item {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .conversation-item:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .conversation-item.active {
      background: rgba(255, 255, 255, 0.3);
    }

    .contact-avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 20px;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .conversation-details {
      flex: 1;
      min-width: 0;
    }

    .conversation-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }

    .contact-name {
      color: white;
      font-weight: 600;
      font-size: 16px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .message-time {
      color: rgba(255, 255, 255, 0.85);
      font-size: 12px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .last-message {
      color: rgba(255, 255, 255, 0.9);
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    /* Main Chat Area */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    .chat-header {
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.25);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.1);
    }

    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .chat-header-name {
      color: white;
      font-weight: 600;
      font-size: 18px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .chat-header-phone {
      color: rgba(255, 255, 255, 0.9);
      font-size: 14px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    .chat-header-phone:hover {
      color: white;
      transform: scale(1.02);
      text-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }

    .chat-header-phone:active {
      transform: scale(0.98);
    }

    .delete-conversation-btn {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.4);
      border-radius: 8px;
      padding: 8px 12px;
      color: rgba(255, 255, 255, 0.95);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .delete-conversation-btn:hover {
      background: rgba(239, 68, 68, 0.3);
      border-color: rgba(239, 68, 68, 0.6);
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      max-width: 70%;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .message.outbound {
      align-self: flex-end;
      align-items: flex-end;
    }

    .message.inbound {
      align-self: flex-start;
      align-items: flex-start;
    }

    .message-bubble {
      padding: 13px 17px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.5;
      word-wrap: break-word;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }

    .message.outbound .message-bubble {
      background: rgba(74, 144, 226, 0.9);
      color: white;
      border-bottom-right-radius: 5px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }

    .message.inbound .message-bubble {
      background: rgba(255, 255, 255, 0.95);
      color: #1a202c;
      border-bottom-left-radius: 5px;
    }

    .message-timestamp {
      font-size: 12px;
      padding: 0 10px;
      font-weight: 500;
    }

    .message.outbound .message-timestamp {
      color: rgba(255, 255, 255, 0.9);
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .message.inbound .message-timestamp {
      color: rgba(255, 255, 255, 0.9);
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    /* Note message styling */
    .message.note {
      justify-content: center;
      opacity: 0.9;
    }

    .message.note .message-bubble {
      background: linear-gradient(135deg, #fef3c7 0%, #fde047 100%);
      color: #78350f;
      border: 2px dashed rgba(251, 191, 36, 0.5);
      font-style: italic;
      max-width: 80%;
    }

    .message.note .message-timestamp {
      color: rgba(120, 53, 15, 0.7);
    }

    .message.note .message-bubble::before {
      content: "üìù ";
    }

    .message-input-area {
      padding: 20px 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.25);
      display: flex;
      gap: 12px;
      background: rgba(255, 255, 255, 0.1);
      align-items: flex-end;
    }

    .message-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.45);
      border-radius: 20px;
      padding: 13px 20px;
      color: white;
      font-size: 15px;
      resize: none;
      max-height: 140px;
      min-height: 46px;
      font-family: inherit;
      transition: all 0.2s;
      line-height: 1.5;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
      /* Hide scrollbar */
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE/Edge */
    }

    .message-input::-webkit-scrollbar {
      display: none; /* Chrome/Safari/Opera */
    }

    .message-input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    .message-input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.45);
      border-color: rgba(255, 255, 255, 0.65);
    }

    .send-btn {
      background: linear-gradient(135deg, #4A90E2 0%, #667eea 100%);
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(74, 144, 226, 0.45);
      flex-shrink: 0;
    }

    .send-btn:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 6px 18px rgba(74, 144, 226, 0.6);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .send-btn svg {
      width: 24px;
      height: 24px;
      fill: white;
    }

    .note-btn {
      background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.45);
      flex-shrink: 0;
      margin-right: 8px;
    }

    .note-btn:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 6px 18px rgba(245, 158, 11, 0.6);
    }

    .note-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .note-btn svg {
      width: 24px;
      height: 24px;
      fill: white;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 20px;
      padding: 28px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .modal-header {
      margin-bottom: 20px;
    }

    .modal-title {
      color: #1a202c;
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .modal-subtitle {
      color: #4a5568;
      font-size: 14px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 24px;
    }

    .modal-btn {
      flex: 1;
      padding: 13px 20px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn-primary {
      background: linear-gradient(135deg, #4A90E2 0%, #667eea 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
    }

    .modal-btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(74, 144, 226, 0.4);
    }

    .modal-btn-secondary {
      background: rgba(0,0,0,0.05);
      color: #4a5568;
    }

    .modal-btn-secondary:hover {
      background: rgba(0,0,0,0.1);
    }

    .contact-list {
      max-height: 400px;
      overflow-y: auto;
      margin: 16px 0;
    }

    .contact-list-item {
      padding: 14px 16px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
      background: rgba(0,0,0,0.03);
    }

    .contact-list-item:hover {
      background: rgba(74, 144, 226, 0.1);
    }

    .contact-list-item-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 17px;
      flex-shrink: 0;
      box-shadow: 0 3px 10px rgba(0,0,0,0.15);
    }

    .contact-list-item-name {
      color: #1a202c;
      font-weight: 600;
      font-size: 15px;
    }

    .contact-list-item-phone {
      color: #718096;
      font-size: 13px;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: rgba(255, 255, 255, 0.75);
      text-align: center;
      padding: 40px;
    }

    .empty-state-icon {
      width: 90px;
      height: 90px;
      margin-bottom: 24px;
      opacity: 0.6;
      stroke: currentColor;
    }

    .empty-state-text {
      font-size: 19px;
      font-weight: 600;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      margin-bottom: 8px;
    }

    .empty-state-subtext {
      font-size: 15px;
      color: rgba(255, 255, 255, 0.7);
      text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.35);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.45);
    }

    /* Loading state */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: rgba(255, 255, 255, 0.85);
      font-size: 16px;
    }

    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Phone Dialer */
    .phone-toggle {
      position: fixed;
      right: 0;
      top: 200px;
      width: 50px;
      height: 60px;
      background: linear-gradient(135deg, rgba(103, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px 0 0 8px;
      box-shadow: -4px 4px 16px rgba(0, 0, 0, 0.25);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 101;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }

    .phone-toggle.open {
      right: 180px;
    }

    .phone-toggle svg {
      width: 20px;
      height: 20px;
      fill: white;
      filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
      position: relative;
      z-index: 2;
    }

    .phone-toggle::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1;
    }

    .phone-toggle:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px) scale(1.05);
      box-shadow: -6px 6px 20px rgba(0, 0, 0, 0.2);
    }

    .phone-toggle:hover::before {
      opacity: 1;
    }

    .phone-sidebar {
      position: fixed;
      right: -180px;
      top: 80px;
      width: 180px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.25);
      border-radius: 8px 0 0 8px;
      box-shadow: -6px 6px 24px rgba(0, 0, 0, 0.25);
      padding: 12px;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
      z-index: 100;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .phone-sidebar.open {
      right: 0;
    }

    .phone-contact-selector {
      width: 100%;
      padding: 6px 8px;
      font-size: 11px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.15);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
      box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .phone-contact-selector:hover {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-1px);
      box-shadow:
        0 6px 20px rgba(0, 0, 0, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .phone-contact-selector:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.6);
      box-shadow:
        0 0 0 3px rgba(255, 255, 255, 0.1),
        0 6px 20px rgba(0, 0, 0, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .phone-display {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      text-align: right;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.15);
      color: white;
      font-weight: 600;
      letter-spacing: 1px;
      box-shadow:
        0 3px 12px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255,255,255,0.2),
        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      min-height: 32px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    .dialpad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-bottom: 8px;
    }

    .dial-btn {
      position: relative;
      padding: 8px 12px;
      min-height: 36px;
      font-size: 14px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.25);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(10px);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .dial-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0) 100%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .dial-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .dial-btn:hover::before {
      opacity: 1;
    }

    .dial-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .call-controls {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }

    .call-btn {
      flex: 1;
      padding: 12px 8px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .call-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.5);
    }

    .call-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .call-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .hangup-btn {
      flex: 1;
      padding: 12px 8px;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .hangup-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.5);
    }

    .hangup-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .clear-btn {
      flex: 1;
      padding: 12px 8px;
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.25);
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
    }

    .clear-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .clear-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .call-status {
      padding: 8px;
      text-align: center;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.15);
      color: white;
      font-weight: 600;
      font-size: 11px;
      min-height: 20px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(10px);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .call-status.calling {
      background: rgba(251, 191, 36, 0.3);
      border-color: rgba(251, 191, 36, 0.4);
      color: #fef3c7;
      box-shadow:
        0 4px 16px rgba(251, 191, 36, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .call-status.connected {
      background: rgba(34, 197, 94, 0.3);
      border-color: rgba(34, 197, 94, 0.4);
      color: #dcfce7;
      box-shadow:
        0 4px 16px rgba(34, 197, 94, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .call-status.error {
      background: rgba(239, 68, 68, 0.3);
      border-color: rgba(239, 68, 68, 0.4);
      color: #fee2e2;
      box-shadow:
        0 4px 16px rgba(239, 68, 68, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    /* Pulsing animation for ringing */
    @keyframes phonePulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 0 20px 10px rgba(102, 126, 234, 0);
      }
    }

    .phone-ringing {
      animation: phonePulse 1.5s ease-in-out infinite;
    }
  </style>

  <!-- JsSIP for WebRTC calling (local copy) -->
  <script src="/libs/jssip.min.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar"></div>
          <div class="user-details">
            <div class="user-name" id="userName">Loading...</div>
            <div class="user-status">Online</div>
          </div>
          <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
        <div class="search-new-container">
          <input type="text" class="search-bar" placeholder="Search conversations..." id="searchBar">
          <div class="button-row">
            <button class="new-message-btn" id="contactsBtn">Contacts</button>
            <button class="new-message-btn" id="newMessageBtn">New</button>
          </div>
        </div>
      </div>

      <div class="conversations" id="conversationsList">
        <div class="loading">
          <div class="spinner"></div>
          Loading conversations...
        </div>
      </div>
    </div>

    <!-- Chat Area -->
    <div class="chat-area" id="chatArea">
      <div class="empty-state">
        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <div class="empty-state-text">Select a conversation</div>
        <div class="empty-state-subtext">Choose a contact to start messaging</div>
      </div>
    </div>
  </div>

  <!-- Contacts Modal -->
  <div class="modal-overlay" id="contactsModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">New Message</div>
        <div class="modal-subtitle">Select a contact to start messaging</div>
      </div>
      <input type="text" class="search-bar" placeholder="Search contacts..." id="contactSearch" style="margin-bottom: 16px;">
      <div class="contact-list" id="contactList"></div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeContactsModal()">Cancel</button>
        <button class="modal-btn modal-btn-primary" onclick="openCreateContactModal()">Create New Contact</button>
      </div>
    </div>
  </div>

  <!-- Create Contact Modal -->
  <div class="modal-overlay" id="createContactModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Create Contact</div>
        <div class="modal-subtitle">Add a new contact to your list</div>
      </div>
      <form id="createContactForm">
        <div style="margin-bottom: 16px;">
          <label style="display: block; color: #1a202c; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Name</label>
          <input type="text" id="contactName" required
                 style="width: 100%; padding: 12px 16px; border: 1px solid #cbd5e0; border-radius: 10px; font-size: 15px; color: #1a202c;"
                 placeholder="John Doe">
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #1a202c; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Phone Number</label>
          <input type="tel" id="contactPhone" required
                 style="width: 100%; padding: 12px 16px; border: 1px solid #cbd5e0; border-radius: 10px; font-size: 15px; color: #1a202c;"
                 placeholder="+1 555 123 4567">
        </div>
        <div class="modal-buttons">
          <button type="button" class="modal-btn modal-btn-secondary" onclick="closeCreateContactModal()">Cancel</button>
          <button type="submit" class="modal-btn modal-btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Contacts Management Modal -->
  <div class="modal-overlay" id="manageContactsModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Contacts</div>
        <div class="modal-subtitle">Manage your contacts</div>
      </div>
      <input type="text" class="search-bar" placeholder="Search contacts..." id="manageContactSearch" style="margin-bottom: 16px;">
      <div class="contact-list" id="manageContactList" style="max-height: 400px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeManageContactsModal()">Close</button>
        <button class="modal-btn modal-btn-primary" onclick="openCreateContactFromManage()">Add Contact</button>
      </div>
    </div>
  </div>

  <!-- Send Confirmation Modal -->
  <div class="modal-overlay" id="sendConfirmModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Send Message?</div>
        <div class="modal-subtitle" id="sendConfirmText">Are you sure you want to send this message?</div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeSendModal()">Cancel</button>
        <button class="modal-btn modal-btn-primary" onclick="confirmSend()">Send</button>
      </div>
    </div>
  </div>

  <!-- Delete Conversation Confirmation Modal -->
  <div class="modal-overlay" id="deleteConfirmModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Delete Conversation?</div>
        <div class="modal-subtitle" id="deleteConfirmText">This will permanently delete all messages with this contact. This action cannot be undone.</div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeDeleteModal()">Cancel</button>
        <button class="modal-btn modal-btn-primary" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Voicemail Warning Modal -->
  <div class="modal-overlay" id="voicemailWarningModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">‚ö†Ô∏è Warning</div>
        <div class="modal-subtitle">Are you sure you want to expose your ears to this?</div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeVoicemailWarning()">Nevermind</button>
        <button class="modal-btn modal-btn-primary" onclick="confirmPlayVoicemail()">I'm Ready</button>
      </div>
    </div>
  </div>

  <!-- Call Confirmation Modal -->
  <div class="modal-overlay" id="callConfirmModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">üìû Call Confirmation</div>
        <div class="modal-subtitle" id="callConfirmText">Are you sure you actually want to talk to this person?</div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeCallConfirm()">Nevermind</button>
        <button class="modal-btn modal-btn-primary" onclick="confirmCall()">Yes, Call Them</button>
      </div>
    </div>
  </div>

  <!-- Phone Dialer -->
  <button class="phone-toggle" id="phoneToggle" onclick="togglePhone()">
    <svg viewBox="0 0 24 24">
      <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 00-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"></path>
    </svg>
  </button>

  <div class="phone-sidebar" id="phoneSidebar">
    <!-- Contact selector -->
    <select class="phone-contact-selector" id="phoneContactSelector" onchange="selectContactForCall()">
      <option value="">Select a contact...</option>
    </select>

    <!-- Phone number display -->
    <input type="text" class="phone-display" id="phoneDisplay" readonly value="" placeholder="Enter number">

    <!-- Dialpad (3x4 grid) -->
    <div class="dialpad">
      <button class="dial-btn" onclick="dialDigit('1')">1</button>
      <button class="dial-btn" onclick="dialDigit('2')">2</button>
      <button class="dial-btn" onclick="dialDigit('3')">3</button>
      <button class="dial-btn" onclick="dialDigit('4')">4</button>
      <button class="dial-btn" onclick="dialDigit('5')">5</button>
      <button class="dial-btn" onclick="dialDigit('6')">6</button>
      <button class="dial-btn" onclick="dialDigit('7')">7</button>
      <button class="dial-btn" onclick="dialDigit('8')">8</button>
      <button class="dial-btn" onclick="dialDigit('9')">9</button>
      <button class="dial-btn" onclick="dialDigit('*')">*</button>
      <button class="dial-btn" onclick="dialDigit('0')">0</button>
      <button class="dial-btn" onclick="dialDigit('#')">#</button>
    </div>

    <!-- Call controls -->
    <div class="call-controls">
      <button class="call-btn" id="callBtn" onclick="showCallConfirm()">Call</button>
      <button class="hangup-btn" id="hangupBtn" onclick="hangupCall()" style="display:none">Hang Up</button>
      <button class="clear-btn" onclick="clearDisplay()">Clear</button>
    </div>

    <!-- Call status -->
    <div class="call-status" id="callStatus">Ready to call</div>
  </div>

  <!-- Hidden audio element for call audio -->
  <audio id="remoteAudio" autoplay></audio>

  <script>
    let currentUser = null;
    let currentContact = null;
    let contacts = [];
    let pendingMessage = '';
    let userDID = null;
    let lastSeenMessageIds = new Set(); // Track message IDs we've already seen
    let pollingInterval = null;

    // Toast notification system
    function showToast(message, type = 'success', duration = 4000) {
      const container = document.getElementById('toastContainer');

      const icons = {
        success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
        info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'
      };

      const titles = {
        success: 'Success',
        info: 'Info'
      };

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <div class="toast-icon">${icons[type]}</div>
        <div class="toast-content">
          <div class="toast-title">${titles[type]}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
        <div class="toast-progress"></div>
      `;

      container.appendChild(toast);

      // Hover-to-pause functionality
      let timeoutId;
      let startTime = Date.now();
      let remainingTime = duration;
      const progressBar = toast.querySelector('.toast-progress');

      // Initial auto-dismiss timeout
      timeoutId = setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
      }, duration);

      // Pause on hover
      toast.addEventListener('mouseenter', () => {
        clearTimeout(timeoutId);
        remainingTime -= (Date.now() - startTime);
        if (progressBar) {
          progressBar.style.animationPlayState = 'paused';
        }
      });

      // Resume on mouse leave
      toast.addEventListener('mouseleave', () => {
        startTime = Date.now();
        timeoutId = setTimeout(() => {
          toast.classList.add('hiding');
          setTimeout(() => toast.remove(), 300);
        }, remainingTime);
        if (progressBar) {
          progressBar.style.animationPlayState = 'running';
        }
      });
    }

    // Check authentication
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/me');
        const data = await response.json();

        if (!data.authenticated) {
          window.location.href = '/login.html';
          return false;
        }

        currentUser = data;

        // Load DID number
        const didResponse = await fetch('/api/config/did');
        const didData = await didResponse.json();

        if (didData.success && didData.did) {
          userDID = didData.did;

          // Format DID for display: 1 (780) 482 5026
          const formatDID = (did) => {
            // Remove all non-digits
            const digits = did.replace(/\D/g, '');
            // Format as: 1 (XXX) XXX XXXX
            if (digits.length === 11 && digits[0] === '1') {
              return `1 (${digits.slice(1, 4)}) ${digits.slice(4, 7)} ${digits.slice(7)}`;
            } else if (digits.length === 10) {
              return `1 (${digits.slice(0, 3)}) ${digits.slice(3, 6)} ${digits.slice(6)}`;
            }
            return did; // Return as-is if format doesn't match
          };

          const userNameEl = document.getElementById('userName');
          userNameEl.textContent = formatDID(userDID);
          userNameEl.title = 'Click to copy';

          // Add click-to-copy functionality - copy digits only
          userNameEl.addEventListener('click', async () => {
            try {
              const digitsOnly = userDID.replace(/\D/g, '');
              await navigator.clipboard.writeText(digitsOnly);
              showToast(`Copied ${digitsOnly} to clipboard!`, 'success');
            } catch (error) {
              console.error('Failed to copy:', error);
              showToast('Failed to copy to clipboard', 'info');
            }
          });
        }

        document.getElementById('userAvatar').textContent = data.username.charAt(0).toUpperCase();
        return true;
      } catch (error) {
        console.error('Auth check failed:', error);
        window.location.href = '/login.html';
        return false;
      }
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await fetch('/api/auth/logout', { method: 'POST' });
        window.location.href = '/login.html';
      } catch (error) {
        console.error('Logout failed:', error);
      }
    });

    // Load conversations
    async function loadConversations() {
      try {
        const response = await fetch('/api/messages');
        const data = await response.json();

        if (data.success && data.conversations) {
          contacts = data.conversations;
          renderConversations(contacts);
        } else {
          document.getElementById('conversationsList').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-text">No conversations yet</div>
              <div class="empty-state-subtext">Click "New" to start messaging</div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Failed to load conversations:', error);
        document.getElementById('conversationsList').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-text">Failed to load</div>
          </div>
        `;
      }
    }

    // Render conversations list
    function renderConversations(contactsList) {
      const container = document.getElementById('conversationsList');

      if (contactsList.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-text">No conversations yet</div>
            <div class="empty-state-subtext">Click "New" to start messaging</div>
          </div>
        `;
        return;
      }

      container.innerHTML = contactsList.map(conv => {
        const time = conv.created_at ? new Date(conv.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
        const preview = conv.content ? (conv.content.length > 40 ? conv.content.substring(0, 40) + '...' : conv.content) : 'No messages yet';
        const name = conv.contact_name || conv.name || conv.phone_number;

        return `
          <div class="conversation-item ${currentContact && currentContact.id === conv.contact_id ? 'active' : ''}"
               data-contact-id="${conv.contact_id}"
               onclick="selectContact('${conv.contact_id}')">
            <div class="contact-avatar" style="background: ${conv.avatar_color}">
              ${name.charAt(0).toUpperCase()}
            </div>
            <div class="conversation-details">
              <div class="conversation-header">
                <span class="contact-name">${escapeHtml(name)}</span>
                ${time ? `<span class="message-time">${time}</span>` : ''}
              </div>
              <div class="last-message">${escapeHtml(preview)}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Select contact and load messages
    window.selectContact = async function(contactId) {
      let conv = contacts.find(c => c.contact_id === contactId);

      // If contact not in conversations (new conversation), fetch from contacts API
      if (!conv) {
        try {
          const response = await fetch('/api/contacts');
          const data = await response.json();

          if (data.success && data.contacts) {
            const contact = data.contacts.find(c => c.id === contactId);
            if (contact) {
              conv = {
                contact_id: contact.id,
                contact_name: contact.name,
                name: contact.name,
                phone_number: contact.phone_number,
                avatar_color: contact.avatar_color
              };
            }
          }
        } catch (error) {
          console.error('Failed to fetch contact:', error);
          return;
        }

        if (!conv) return; // Still not found
      }

      currentContact = {
        id: conv.contact_id,
        name: conv.contact_name || conv.name,
        phone_number: conv.phone_number,
        avatar_color: conv.avatar_color
      };
      renderConversations(contacts); // Update active state
      await loadMessages(contactId);
    };

    // Load messages for a contact
    async function loadMessages(contactId) {
      const chatArea = document.getElementById('chatArea');

      chatArea.innerHTML = `
        <div class="chat-header">
          <div class="chat-header-left">
            <div class="contact-avatar" style="background: ${currentContact.avatar_color}; width: 46px; height: 46px; font-size: 18px;">
              ${currentContact.name.charAt(0).toUpperCase()}
            </div>
            <div>
              <div class="chat-header-name">${escapeHtml(currentContact.name)}</div>
              <div class="chat-header-phone" onclick="openDialerWithNumber('${escapeHtml(currentContact.phone_number)}')" title="Click to call">${escapeHtml(currentContact.phone_number)}</div>
            </div>
          </div>
          <button class="delete-conversation-btn" onclick="showDeleteModal()" title="Delete Conversation">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14z"></path>
            </svg>
          </button>
        </div>
        <div class="messages-container" id="messagesContainer">
          <div class="loading">
            <div class="spinner"></div>
            Loading messages...
          </div>
        </div>
        <div class="message-input-area">
          <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
          <button class="note-btn" id="noteBtn" title="Add private note">
            <svg viewBox="0 0 24 24">
              <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
            </svg>
          </button>
          <button class="send-btn" id="sendBtn">
            <svg viewBox="0 0 24 24">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
            </svg>
          </button>
        </div>
      `;

      setupMessageHandlers();

      try {
        const response = await fetch(`/api/messages/conversation/${contactId}`);
        const data = await response.json();

        if (data.success && data.messages) {
          renderMessages(data.messages);
        } else {
          document.getElementById('messagesContainer').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-text">No messages yet</div>
              <div class="empty-state-subtext">Start the conversation!</div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Failed to load messages:', error);
        document.getElementById('messagesContainer').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-text">Failed to load messages</div>
          </div>
        `;
      }
    }

    // Render messages
    function renderMessages(messages) {
      const container = document.getElementById('messagesContainer');

      if (messages.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-text">No messages yet</div>
            <div class="empty-state-subtext">Start the conversation!</div>
          </div>
        `;
        return;
      }

      container.innerHTML = messages.map(msg => {
        const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        let label = '';

        // Handle different message types
        if (msg.direction === 'note') {
          label = 'Private Note ‚Ä¢ ';
        } else if (msg.direction === 'outbound') {
          label = 'Me ‚Ä¢ ';
        } else {
          // For inbound, show contact name or phone number
          const name = currentContact.name || currentContact.phone_number;
          label = `${name} ‚Ä¢ `;
        }

        const voicemailLink = msg.voicemail_blob_url
          ? `<div style="margin-top: 8px;"><a href="#" onclick="showVoicemailWarning('${escapeHtml(msg.voicemail_blob_url)}'); return false;" style="color: #667eea; text-decoration: none; font-size: 13px;">üéß Listen to voicemail ‚Üí</a></div>`
          : '';

        return `
          <div class="message ${msg.direction}">
            <div class="message-bubble">
              ${escapeHtml(msg.content)}
              ${voicemailLink}
            </div>
            <div class="message-timestamp">${label}${time}</div>
          </div>
        `;
      }).join('');

      container.scrollTop = container.scrollHeight;
    }

    // Setup message input handlers
    function setupMessageHandlers() {
      const input = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');

      input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 140) + 'px';
      });

      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          // Enter just adds newline, no auto-send
          return;
        }
      });

      sendBtn.addEventListener('click', () => {
        const message = input.value.trim();
        if (message) {
          showSendModal(message);
        }
      });

      // Note button handler
      const noteBtn = document.getElementById('noteBtn');
      noteBtn.addEventListener('click', async () => {
        const message = input.value.trim();
        if (!message) return;
        if (!currentContact) {
          console.error('No current contact selected');
          return;
        }

        console.log('Saving note for contact:', currentContact);

        const noteBtn = document.getElementById('noteBtn');
        noteBtn.disabled = true;

        try {
          const noteData = {
            phoneNumber: currentContact.phone_number,
            body: message
          };
          console.log('Sending note data:', noteData);

          const response = await fetch('/api/messages/note', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(noteData)
          });

          if (response.ok) {
            input.value = '';
            input.style.height = 'auto';
            showToast('Note saved', 'info');
            await loadMessages(currentContact.id); // Refresh to show note
          } else {
            showToast('Failed to save note', 'error');
          }
        } catch (error) {
          console.error('Error saving note:', error);
          showToast('Error saving note', 'error');
        } finally {
          noteBtn.disabled = false;
        }
      });
    }

    // Show send confirmation modal
    function showSendModal(message) {
      pendingMessage = message;
      const preview = message.length > 100 ? message.substring(0, 100) + '...' : message;
      document.getElementById('sendConfirmText').textContent = `Send this message? "${preview}"`;
      document.getElementById('sendConfirmModal').classList.add('show');
    }

    // Close send modal
    window.closeSendModal = function() {
      document.getElementById('sendConfirmModal').classList.remove('show');
      pendingMessage = '';
    };

    // Confirm and send message
    window.confirmSend = async function() {
      const sendBtn = document.getElementById('sendBtn');
      const input = document.getElementById('messageInput');

      // Capture message before closing modal (which clears pendingMessage)
      const messageToSend = pendingMessage;

      closeSendModal();
      sendBtn.disabled = true;
      input.disabled = true;

      try {
        const response = await fetch('/api/messages/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contact_id: currentContact.id,
            message: messageToSend
          })
        });

        const data = await response.json();

        if (data.success) {
          input.value = '';
          input.style.height = 'auto';
          await loadMessages(currentContact.id);
          showToast('Message sent successfully!', 'success');
        } else {
          showToast('Failed to send message: ' + (data.error || 'Unknown error'), 'info');
        }
      } catch (error) {
        console.error('Failed to send message:', error);
        showToast('Failed to send message. Please try again.', 'info');
      } finally {
        sendBtn.disabled = false;
        input.disabled = false;
        input.focus();
        pendingMessage = '';
      }
    };

    // Delete conversation modal functions
    let pendingDeleteContactId = null;

    window.showDeleteModal = function() {
      if (!currentContact) return;
      pendingDeleteContactId = currentContact.id;
      document.getElementById('deleteConfirmModal').classList.add('show');
    };

    window.closeDeleteModal = function() {
      document.getElementById('deleteConfirmModal').classList.remove('show');
      pendingDeleteContactId = null;
    };

    window.confirmDelete = async function() {
      if (!pendingDeleteContactId) return;

      const contactToDelete = pendingDeleteContactId;
      closeDeleteModal();

      try {
        const response = await fetch(`/api/messages/conversation/${contactToDelete}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
          showToast('Conversation deleted', 'success');
          currentContact = null;
          await loadConversations();

          // Show empty state
          document.getElementById('chatArea').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-text">Select a conversation</div>
            </div>
          `;
        } else {
          showToast('Failed to delete conversation: ' + (data.error || 'Unknown error'), 'info');
        }
      } catch (error) {
        console.error('Failed to delete conversation:', error);
        showToast('Failed to delete conversation. Please try again.', 'info');
      }

      pendingDeleteContactId = null;
    };

    // Voicemail warning modal functions
    let pendingVoicemailUrl = null;

    window.showVoicemailWarning = function(url) {
      pendingVoicemailUrl = url;
      document.getElementById('voicemailWarningModal').classList.add('show');
    };

    window.closeVoicemailWarning = function() {
      document.getElementById('voicemailWarningModal').classList.remove('show');
      pendingVoicemailUrl = null;
    };

    window.confirmPlayVoicemail = function() {
      if (pendingVoicemailUrl) {
        window.open(pendingVoicemailUrl, '_blank');
        closeVoicemailWarning();
      }
    };

    // New message button - show contacts modal
    document.getElementById('newMessageBtn').addEventListener('click', () => {
      showContactsModal();
    });

    // Contacts button - show manage contacts modal
    document.getElementById('contactsBtn').addEventListener('click', () => {
      showManageContactsModal();
    });

    // Show contacts modal
    async function showContactsModal() {
      const modal = document.getElementById('contactsModal');
      const contactList = document.getElementById('contactList');

      contactList.innerHTML = '<div class="loading"><div class="spinner"></div>Loading contacts...</div>';
      modal.classList.add('show');

      try {
        const response = await fetch('/api/contacts');
        const data = await response.json();

        if (data.success && data.contacts) {
          renderContactList(data.contacts);
        } else {
          contactList.innerHTML = '<div class="empty-state"><div class="empty-state-text">No contacts found</div></div>';
        }
      } catch (error) {
        console.error('Failed to load contacts:', error);
        contactList.innerHTML = '<div class="empty-state"><div class="empty-state-text">Failed to load contacts</div></div>';
      }
    }

    // Render contact list in modal
    function renderContactList(contactsList) {
      const contactList = document.getElementById('contactList');

      if (contactsList.length === 0) {
        contactList.innerHTML = '<div class="empty-state"><div class="empty-state-text">No contacts found</div></div>';
        return;
      }

      contactList.innerHTML = contactsList.map(contact => `
        <div class="contact-list-item" onclick="selectContactFromModal('${contact.id}')">
          <div class="contact-list-item-avatar" style="background: ${contact.avatar_color}">
            ${contact.name.charAt(0).toUpperCase()}
          </div>
          <div>
            <div class="contact-list-item-name">${escapeHtml(contact.name)}</div>
            <div class="contact-list-item-phone">${escapeHtml(contact.phone_number)}</div>
          </div>
        </div>
      `).join('');
    }

    // Select contact from modal
    window.selectContactFromModal = function(contactId) {
      closeContactsModal();
      selectContact(contactId);
    };

    // Close contacts modal
    window.closeContactsModal = function() {
      document.getElementById('contactsModal').classList.remove('show');
    };

    // Open create contact modal
    window.openCreateContactModal = function() {
      document.getElementById('contactsModal').classList.remove('show');
      document.getElementById('createContactModal').classList.add('show');
    };

    // Close create contact modal
    window.closeCreateContactModal = function() {
      document.getElementById('createContactModal').classList.remove('show');
      document.getElementById('createContactForm').reset();
    };

    // Handle create contact form submission
    document.getElementById('createContactForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const name = document.getElementById('contactName').value.trim();
      const phone = document.getElementById('contactPhone').value.trim();

      if (!name || !phone) {
        alert('Please fill in all fields');
        return;
      }

      try {
        const response = await fetch('/api/contacts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: name,
            phone_number: phone
          })
        });

        const data = await response.json();

        if (data.success) {
          closeCreateContactModal();
          await loadConversations();
          showToast(`Contact "${name}" created successfully!`, 'success');
        } else {
          showToast('Failed to create contact: ' + (data.error || 'Unknown error'), 'info');
        }
      } catch (error) {
        console.error('Failed to create contact:', error);
        showToast('Failed to create contact. Please try again.', 'info');
      }
    });

    // Search contacts in modal
    document.getElementById('contactSearch').addEventListener('input', function(e) {
      const query = e.target.value.toLowerCase();
      const filtered = contacts.filter(contact =>
        contact.name.toLowerCase().includes(query) ||
        contact.phone_number.includes(query)
      );
      renderContactList(filtered);
    });

    // Show manage contacts modal
    async function showManageContactsModal() {
      const modal = document.getElementById('manageContactsModal');
      const contactList = document.getElementById('manageContactList');

      contactList.innerHTML = '<div class="loading"><div class="spinner"></div>Loading contacts...</div>';
      modal.classList.add('show');

      try {
        const response = await fetch('/api/contacts');
        const data = await response.json();

        if (data.success && data.contacts) {
          contacts = data.contacts; // Store for search
          renderManageContactList(data.contacts);
        } else {
          contactList.innerHTML = '<div class="empty-state"><div class="empty-state-text">No contacts found</div></div>';
        }
      } catch (error) {
        console.error('Failed to load contacts:', error);
        contactList.innerHTML = '<div class="empty-state"><div class="empty-state-text">Failed to load contacts</div></div>';
      }
    }

    // Render contact list in manage contacts modal
    function renderManageContactList(contactsList) {
      const contactList = document.getElementById('manageContactList');

      if (contactsList.length === 0) {
        contactList.innerHTML = '<div class="empty-state"><div class="empty-state-text">No contacts found</div></div>';
        return;
      }

      contactList.innerHTML = contactsList.map(contact => `
        <div class="contact-list-item">
          <div class="contact-list-item-avatar" style="background: ${contact.avatar_color}">
            ${contact.name.charAt(0).toUpperCase()}
          </div>
          <div style="flex: 1;">
            <div class="contact-list-item-name">${escapeHtml(contact.name)}</div>
            <div class="contact-list-item-phone">${escapeHtml(contact.phone_number)}</div>
          </div>
        </div>
      `).join('');
    }

    // Close manage contacts modal
    window.closeManageContactsModal = function() {
      document.getElementById('manageContactsModal').classList.remove('show');
      document.getElementById('manageContactSearch').value = '';
    };

    // Open create contact modal from manage contacts
    window.openCreateContactFromManage = function() {
      closeManageContactsModal();
      document.getElementById('createContactModal').classList.add('show');
    };

    // Search contacts in manage modal
    document.getElementById('manageContactSearch').addEventListener('input', function(e) {
      const query = e.target.value.toLowerCase();
      const filtered = contacts.filter(contact =>
        contact.name.toLowerCase().includes(query) ||
        contact.phone_number.includes(query)
      );
      renderManageContactList(filtered);
    });

    // Search conversations
    document.getElementById('searchBar').addEventListener('input', function(e) {
      const query = e.target.value.toLowerCase();
      const filtered = contacts.filter(contact =>
        contact.name.toLowerCase().includes(query) ||
        contact.phone_number.includes(query)
      );
      renderConversations(filtered);
    });

    // Close modals on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.remove('show');
        }
      });
    });

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Poll for new messages
    async function pollForNewMessages() {
      try {
        const response = await fetch('/api/messages');
        const data = await response.json();

        if (data.success && data.conversations) {
          const newMessages = [];

          // Check for messages we haven't seen before
          data.conversations.forEach(conv => {
            if (!lastSeenMessageIds.has(conv.message_id)) {
              // This is a new message
              newMessages.push(conv);
              lastSeenMessageIds.add(conv.message_id);
            }
          });

          // Show toast for new INBOUND messages only (not our own sent messages)
          newMessages.forEach(conv => {
            if (conv.direction === 'inbound') {
              const name = conv.contact_name || conv.phone_number;
              const preview = conv.content.length > 50 ? conv.content.substring(0, 50) + '...' : conv.content;
              showToast(`${name}: ${preview}`, 'info', 6000);
            }
          });

          // Update conversation list if we got new messages
          if (newMessages.length > 0) {
            contacts = data.conversations;
            renderConversations(contacts);

            // If viewing a conversation that got a new message, refresh it
            if (currentContact && newMessages.some(m => m.contact_id === currentContact.id)) {
              await loadMessages(currentContact.id);
            }
          }
        }
      } catch (error) {
        console.error('Polling error:', error);
        // Don't show error toast, just log it
      }
    }

    // Start polling for new messages
    function startPolling() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
      }

      // Poll every 5 seconds
      pollingInterval = setInterval(pollForNewMessages, 5000);
    }

    // Stop polling
    function stopPolling() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
      }
    }

    // Check for new voicemails
    async function checkVoicemails() {
      // Always show "Checking for voicemails..." on page load
      const container = document.getElementById('toastContainer');
      const loadingToast = document.createElement('div');
      loadingToast.className = 'toast info';
      loadingToast.innerHTML = `
        <div class="toast-icon">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" opacity="0.25"></circle>
            <path d="M12 2 A10 10 0 0 1 22 12" stroke-linecap="round">
              <animateTransform
                attributeName="transform"
                type="rotate"
                from="0 12 12"
                to="360 12 12"
                dur="1s"
                repeatCount="indefinite"/>
            </path>
          </svg>
        </div>
        <div class="toast-content">
          <div class="toast-title">Info</div>
          <div class="toast-message">Checking for voicemails...</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
      `;
      container.appendChild(loadingToast);

      try {
        const response = await fetch('/api/voicemail/sync');
        const data = await response.json();

        if (!data.success) {
          loadingToast.remove();
          return;
        }

        // Check if there are new voicemails
        if (data.newVoicemails && data.newVoicemails.length > 0) {
          // Update toast to show processing
          loadingToast.querySelector('.toast-message').textContent =
            `Processing ${data.newVoicemails.length} new voicemail${data.newVoicemails.length > 1 ? 's' : ''}...`;

          // Show success toasts after processing
          setTimeout(() => {
            loadingToast.remove();
            data.newVoicemails.forEach(vm => {
              showToast(`New voicemail from ${vm.from}`, 'success');
            });
          }, 1500);

          // Reload conversations to show new voicemails
          await loadConversations();
        } else {
          // No new voicemails - update toast and auto-dismiss
          loadingToast.querySelector('.toast-message').textContent = 'No voicemails in system';
          setTimeout(() => {
            loadingToast.remove();
          }, 2000);
        }

      } catch (error) {
        console.error('Failed to check voicemails:', error);
        loadingToast.remove();
        // Don't show error toast - this is a background operation
      }
    }

    // Initialize app
    async function init() {
      const authenticated = await checkAuth();
      if (authenticated) {
        await loadConversations();

        // Track all initial message IDs so we don't show toasts for them
        contacts.forEach(conv => {
          lastSeenMessageIds.add(conv.message_id);
        });

        // Check for new voicemails (non-blocking)
        checkVoicemails();

        // Start polling for new messages
        startPolling();
      }
    }

    // ============================================
    // PHONE DIALER - SIP.js Integration
    // ============================================

    let userAgent = null;
    let currentSession = null;
    let callStartTime = null;
    let sipServerConfig = null; // Store SIP server config for making calls

    // Toggle phone sidebar
    function togglePhone() {
      const sidebar = document.getElementById('phoneSidebar');
      const toggle = document.getElementById('phoneToggle');
      const isOpening = !sidebar.classList.contains('open');

      sidebar.classList.toggle('open');
      toggle.classList.toggle('open');

      // Populate contact selector when opening
      if (isOpening) {
        populateContactSelector();
      }
    }

    // Format phone number for display: (780) 226-5961
    function formatPhoneDisplay(phoneNumber) {
      // Strip all non-digit characters
      const digitsOnly = phoneNumber.replace(/\D/g, '');

      // Handle North American 10-digit numbers
      if (digitsOnly.length === 10) {
        return `(${digitsOnly.slice(0, 3)}) ${digitsOnly.slice(3, 6)}-${digitsOnly.slice(6)}`;
      }
      // Handle 11-digit numbers starting with 1
      else if (digitsOnly.length === 11 && digitsOnly[0] === '1') {
        return `(${digitsOnly.slice(1, 4)}) ${digitsOnly.slice(4, 7)}-${digitsOnly.slice(7)}`;
      }
      // Return as-is for other formats
      return phoneNumber;
    }

    // Open dialer with pre-populated number
    window.openDialerWithNumber = function(phoneNumber) {
      const sidebar = document.getElementById('phoneSidebar');
      const toggle = document.getElementById('phoneToggle');

      // Strip formatting and keep only digits
      const digitsOnly = phoneNumber.replace(/\D/g, '');

      // Open the dialer if not already open
      if (!sidebar.classList.contains('open')) {
        sidebar.classList.add('open');
        toggle.classList.add('open');
        populateContactSelector();
      }

      // Set the phone number with formatting
      document.getElementById('phoneDisplay').value = formatPhoneDisplay(digitsOnly);

      // Auto-select the contact in the dropdown if they exist
      const selector = document.getElementById('phoneContactSelector');
      const matchingContact = contacts.find(c => c.phone_number.replace(/\D/g, '') === digitsOnly);

      if (matchingContact) {
        selector.value = digitsOnly;
      } else {
        selector.value = '';
      }
    };

    // Populate contact selector dropdown
    function populateContactSelector() {
      const selector = document.getElementById('phoneContactSelector');

      // Clear existing options (except the first one)
      selector.innerHTML = '<option value="">Select a contact...</option>';

      // Add contacts from the conversations list
      contacts.forEach(contact => {
        const option = document.createElement('option');
        const name = contact.contact_name || contact.name || contact.phone_number;
        const phone = contact.phone_number.replace(/\D/g, ''); // Strip formatting
        const formattedPhone = formatPhoneDisplay(phone);

        option.value = phone;
        option.textContent = name;
        selector.appendChild(option);
      });
    }

    // Handle contact selection from dropdown
    window.selectContactForCall = function() {
      const selector = document.getElementById('phoneContactSelector');
      const phoneNumber = selector.value;

      if (phoneNumber) {
        document.getElementById('phoneDisplay').value = formatPhoneDisplay(phoneNumber);
      }
    };

    // Dial a digit
    function dialDigit(digit) {
      const display = document.getElementById('phoneDisplay');

      // Send DTMF if in active call
      if (currentSession && currentSession.isEstablished()) {
        try {
          currentSession.sendDTMF(digit);
          console.log('[Phone] Sent DTMF:', digit);
        } catch (e) {
          console.error('[Phone] DTMF error:', e);
        }
        // During a call, just append without formatting
        display.value += digit;
      } else {
        // Before calling, add digit and reformat
        const currentDigits = display.value.replace(/\D/g, '');
        const newDigits = currentDigits + digit;
        display.value = formatPhoneDisplay(newDigits);
      }
    }

    // Clear display
    function clearDisplay() {
      document.getElementById('phoneDisplay').value = '';
    }

    // Update call status
    function updateCallStatus(message, statusClass = '') {
      const statusEl = document.getElementById('callStatus');
      statusEl.textContent = message;
      statusEl.className = 'call-status ' + statusClass;
    }

    // Initialize JsSIP User Agent
    async function initializeSIP(retryCount = 0) {
      const maxRetries = 5;

      console.log(`[Phone] Attempting to initialize SIP... (attempt ${retryCount + 1}/${maxRetries + 1})`);
      console.log('[Phone] JsSIP library status:', typeof JsSIP !== 'undefined' ? 'loaded' : 'NOT LOADED');

      try {
        // Check if JsSIP is loaded
        if (typeof JsSIP === 'undefined') {
          if (retryCount < maxRetries) {
            console.warn(`[Phone] JsSIP not ready yet, retrying in ${(retryCount + 1) * 200}ms...`);
            setTimeout(() => initializeSIP(retryCount + 1), (retryCount + 1) * 200);
            return;
          } else {
            console.error('[Phone] JsSIP library failed to load after multiple attempts');
            updateCallStatus('SIP library not available', 'error');
            return;
          }
        }

        console.log('[Phone] JsSIP loaded successfully, fetching SIP config...');

        // Fetch SIP configuration from server
        const sipConfigResponse = await fetch('/api/config/sip');
        if (!sipConfigResponse.ok) {
          throw new Error('Failed to fetch SIP configuration');
        }

        const sipConfigData = await sipConfigResponse.json();
        if (!sipConfigData.success) {
          throw new Error(sipConfigData.error || 'SIP configuration error');
        }

        const sipConfig = sipConfigData.config;
        sipServerConfig = sipConfig; // Store globally for making calls

        console.log('[Phone] SIP config loaded:', {
          server: sipConfig.server,
          port: sipConfig.port,
          user: sipConfig.user
        });

        const wsUrl = `wss://${sipConfig.server}:${sipConfig.port}`;
        const socket = new JsSIP.WebSocketInterface(wsUrl);

        const configuration = {
          sockets: [socket],
          uri: `sip:${sipConfig.user}@${sipConfig.server}`,
          authorization_user: sipConfig.user,
          password: sipConfig.password,
          display_name: sipConfig.displayName,
          session_timers: false,
          connection_recovery_min_interval: 2,
          connection_recovery_max_interval: 30
        };

        console.log('[Phone] Creating JsSIP User Agent with config:', {
          uri: configuration.uri,
          socket: wsUrl
        });

        userAgent = new JsSIP.UA(configuration);

        // Connection lifecycle events
        userAgent.on('connecting', (event) => {
          console.log('[Phone] üîÑ Connecting to VoIP.ms:', wsUrl);
          updateCallStatus('Connecting...', '');
        });

        userAgent.on('connected', (event) => {
          console.log('[Phone] ‚úÖ WebSocket connected to:', wsUrl);
        });

        userAgent.on('disconnected', (event) => {
          console.warn('[Phone] ‚ö†Ô∏è WebSocket disconnected');
          console.warn('[Phone] Disconnect event:', event);
          updateCallStatus('Disconnected', 'error');
        });

        // Registration events
        userAgent.on('registered', (event) => {
          console.log('[Phone] ‚úÖ SIP registered successfully');
          updateCallStatus('Ready to call', '');
        });

        userAgent.on('registrationFailed', (event) => {
          console.error('[Phone] ‚ùå SIP registration failed');
          console.error('[Phone] Cause:', event.cause);
          console.error('[Phone] Response:', event.response ? {
            status_code: event.response.status_code,
            reason_phrase: event.response.reason_phrase,
            headers: event.response.headers
          } : 'No response');
          updateCallStatus('Registration failed: ' + event.cause, 'error');
        });

        userAgent.on('unregistered', (event) => {
          console.warn('[Phone] ‚ö†Ô∏è SIP unregistered');
          console.warn('[Phone] Event:', event);
          updateCallStatus('Not registered', 'error');
        });

        console.log('[Phone] JsSIP User Agent created, starting registration...');
        console.log('[Phone] Will attempt to connect to:', wsUrl);
        userAgent.start();

      } catch (error) {
        console.error('[Phone] ‚ùå SIP initialization error:', error);
        console.error('[Phone] Error details:', {
          message: error.message,
          stack: error.stack
        });
        updateCallStatus('Initialization failed', 'error');
      }
    }

    // Show call confirmation modal
    function showCallConfirm() {
      console.log('[Phone] Call button clicked');

      const phoneNumber = document.getElementById('phoneDisplay').value.trim();
      if (!phoneNumber) {
        console.warn('[Phone] No phone number entered');
        updateCallStatus('Enter a number first', 'error');
        return;
      }

      console.log('[Phone] Phone number to call:', phoneNumber);

      if (!userAgent) {
        console.error('[Phone] ‚ùå User agent not initialized');
        updateCallStatus('SIP not ready', 'error');
        return;
      }

      // Find contact name if it exists
      const cleanedNumber = phoneNumber.replace(/\D/g, '');
      const contact = contacts.find(c => c.phone_number.replace(/\D/g, '') === cleanedNumber);
      const displayName = contact ? (contact.contact_name || contact.name || contact.phone_number) : formatPhoneDisplay(cleanedNumber);

      console.log('[Phone] Showing call confirmation for:', displayName, '(contact found:', !!contact, ')');

      document.getElementById('callConfirmText').textContent =
        `Are you sure you want to talk to ${displayName}?`;
      document.getElementById('callConfirmModal').classList.add('show');
    }

    // Close call confirmation modal
    window.closeCallConfirm = function() {
      document.getElementById('callConfirmModal').classList.remove('show');
    };

    // Confirm and make the call
    window.confirmCall = function() {
      closeCallConfirm();
      actuallyMakeCall();
    };

    // Format phone number for North America dialing
    function formatForDialing(phoneNumber) {
      // Strip all non-digit characters
      const digitsOnly = phoneNumber.replace(/\D/g, '');

      // Handle North American numbers (10 or 11 digits)
      if (digitsOnly.length === 10) {
        // 10 digits: add country code +1
        return '1' + digitsOnly;
      } else if (digitsOnly.length === 11 && digitsOnly[0] === '1') {
        // 11 digits starting with 1: already has country code
        return digitsOnly;
      } else {
        // Other lengths: return as-is (for special codes like *97, etc.)
        return digitsOnly;
      }
    }

    // Make outbound call (actual implementation)
    function actuallyMakeCall() {
      const phoneNumber = document.getElementById('phoneDisplay').value.trim();
      const formattedNumber = formatForDialing(phoneNumber);

      console.log('[Phone] ===== INITIATING CALL =====');
      console.log('[Phone] Display number:', phoneNumber);
      console.log('[Phone] Formatted for dialing:', formattedNumber);

      // IMMEDIATE UI FEEDBACK - Update UI before making call
      updateCallStatus('Calling...', 'calling');
      document.getElementById('callBtn').style.display = 'none';
      document.getElementById('hangupBtn').style.display = 'block';

      // Mute early media immediately
      const remoteAudio = document.getElementById('remoteAudio');
      remoteAudio.volume = 0;

      // Start pulsing animation immediately
      const phoneToggle = document.getElementById('phoneToggle');
      phoneToggle.classList.add('phone-ringing');

      try {

        const sipServer = sipServerConfig?.server || 'vancouver3.voip.ms';
        const target = `sip:${formattedNumber}@${sipServer}`;
        console.log('[Phone] SIP target:', target);

        const options = {
          mediaConstraints: {
            audio: true,
            video: false
          },
          pcConfig: {
            iceServers: [
              { urls: 'stun:stun.l.google.com:19302' },
              { urls: 'stun:stun1.l.google.com:19302' }
            ]
          }
        };

        console.log('[Phone] Initiating call...');
        currentSession = userAgent.call(target, options);
        callStartTime = Date.now();

        // Set up call event handlers
        currentSession.on('progress', (event) => {
          console.log('[Phone] üìû Call progress (ringing)');
          updateCallStatus('Ringing...', 'calling');
          // UI already updated immediately on call button click
        });

        currentSession.on('accepted', (event) => {
          console.log('[Phone] ‚úÖ Call accepted - connected!');
          updateCallStatus('Connected', 'connected');
          document.getElementById('callBtn').style.display = 'none';
          document.getElementById('hangupBtn').style.display = 'block';

          // Attach remote audio
          const remoteAudio = document.getElementById('remoteAudio');
          const remoteStream = event.stream || currentSession.connection.getRemoteStreams()[0];
          if (remoteStream) {
            remoteAudio.srcObject = remoteStream;
          }

          // Unmute audio for actual call
          remoteAudio.volume = 1;

          // Remove pulsing animation
          const phoneToggle = document.getElementById('phoneToggle');
          phoneToggle.classList.remove('phone-ringing');
        });

        currentSession.on('ended', (event) => {
          const duration = callStartTime ? Math.floor((Date.now() - callStartTime) / 1000) : 0;
          console.log(`[Phone] üî¥ Call ended - Duration: ${duration}s - Cause:`, event.cause);
          updateCallStatus('Call ended', '');
          document.getElementById('callBtn').style.display = 'block';
          document.getElementById('hangupBtn').style.display = 'none';

          // Remove pulsing animation
          const phoneToggle = document.getElementById('phoneToggle');
          phoneToggle.classList.remove('phone-ringing');

          // Save call history with formatted number
          console.log('[Phone] Saving call history...');
          saveCallHistory(formattedNumber, duration, 'completed');

          currentSession = null;
          callStartTime = null;
        });

        currentSession.on('failed', (event) => {
          console.error('[Phone] ‚ùå Call failed - Event:', event);
          const reason = event.cause || 'Unknown error';
          console.error('[Phone] Failure reason:', reason);
          updateCallStatus('Call failed: ' + reason, 'error');
          document.getElementById('callBtn').style.display = 'block';
          document.getElementById('hangupBtn').style.display = 'none';

          // Remove pulsing animation
          const phoneToggle = document.getElementById('phoneToggle');
          phoneToggle.classList.remove('phone-ringing');

          // Save call history with formatted number
          saveCallHistory(formattedNumber, 0, 'failed');

          currentSession = null;
          callStartTime = null;
        });

      } catch (error) {
        console.error('[Phone] ‚ùå Exception during call:', error);
        console.error('[Phone] Error stack:', error.stack);
        updateCallStatus('Error: ' + error.message, 'error');
      }
    }

    // Hang up call
    function hangupCall() {
      if (currentSession) {
        try {
          console.log('[Phone] Hanging up...');
          currentSession.terminate();
        } catch (error) {
          console.error('[Phone] Error hanging up:', error);
        }
      }
    }

    // Save call history to database
    async function saveCallHistory(phoneNumber, duration, status) {
      try {
        const response = await fetch('/api/calls/save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            phone_number: phoneNumber,
            duration: duration,
            status: status
          })
        });

        if (response.ok) {
          console.log('[Phone] Call history saved');
          // Reload conversations to show call in history
          await loadConversations();
        } else {
          console.error('[Phone] Failed to save call history');
        }
      } catch (error) {
        console.error('[Phone] Error saving call history:', error);
      }
    }

    // Initialize SIP after all functions are defined and JsSIP is loaded
    if (typeof JsSIP !== 'undefined') {
      console.log('[Phone] JsSIP loaded, version:', JsSIP.version);
      initializeSIP();
    } else {
      console.error('[Phone] JsSIP not loaded - phone dialer will not work');
    }

    // ============================================
    // END PHONE DIALER
    // ============================================

    init();
  </script>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

</body>
</html>
